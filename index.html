<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>电器声纹检测演示</title>
    <!-- 引入 MQTT 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        /* 全局样式修复：禁止滚动，固定屏幕 */
        body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; background-color: #000; color: #fff; height: 100vh; width: 100vw; overflow: hidden; }
        
        /* 角色选择界面 */
        #role-select { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; wudth: 100%; z-index: 10; background: #222; position: absolute; top:0; left:0; }
        button { padding: 15px 30px; font-size: 18px; margin: 10px; cursor: pointer; border-radius: 8px; border: none; background: #007bff; color: white; }
        
        /* 展示端布局修复：强制固定比例 */
        #display-view { display: none; height: 100%; width: 100%; flex-direction: column; }
        
        /* Canvas 容器：使用 relative + overflow hidden 防止被撑大 */
        #canvas-container { 
            flex: 1; /* 占据剩余空间 */
            position: relative; 
            width: 100%;
            overflow: hidden; 
            background: #111; 
            border-bottom: 2px solid #333; 
        }
        
        /* Canvas 本体：使用 absolute 强制填满容器 */
        canvas { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%; 
            display: block; 
        }
        
        /* 底部文字区域 */
        #text-container { 
            height: 40%; /* 固定高度比例 */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            text-align: center; 
            background: #000; 
            box-sizing: border-box;
        }
        #status-title { font-size: 18px; color: #888; margin-bottom: 10px; }
        #status-result { font-size: 28px; font-weight: bold; color: #0f0; }
        
        /* 控制端样式 */
        #control-view { display: none; padding: 20px; text-align: center; height: 100%; overflow-y: auto; }
        .ctrl-btn { width: 100%; padding: 20px; margin-bottom: 15px; font-size: 20px; background: #333; border: 1px solid #555; }
        .ctrl-btn:active { background: #555; }
        
        .overlay-text { position: absolute; top: 10px; left: 10px; color: #0f0; font-family: monospace; font-size: 12px; z-index: 5;}
        
        /* 连接状态提示 */
        #connection-status {
            position: fixed; top: 0; right: 0; background: red; padding: 5px; font-size: 12px; z-index: 100; display: none;
        }
    </style>
</head>
<body>

    <div id="connection-status">连接断开</div>

    <!-- 1. 角色选择 -->
    <div id="role-select">
        <h2>请选择模式</h2>
        <button onclick="startDisplay()">我是展示端 (手机)</button>
        <button onclick="startController()">我是控制端 (遥控)</button>
        <p style="color:#666; font-size:12px; margin-top:20px;">v2.0 修复版</p>
    </div>

    <!-- 2. 展示端 -->
    <div id="display-view">
        <div id="canvas-container">
            <div class="overlay-text">Spectrum Analysis // LIVE</div>
            <canvas id="visualizer"></canvas>
        </div>
        <div id="text-container">
            <div id="status-title">解析结果</div>
            <div id="status-result">等待检测...</div>
        </div>
    </div>

    <!-- 3. 控制端 -->
    <div id="control-view">
        <h2>演示控制台</h2>
        <p>点击按钮发送指令</p>
        <button class="ctrl-btn" onclick="sendCommand('无设备', 'normal')">无设备 (复位)</button>
        <button class="ctrl-btn" style="color:#0f0" onclick="sendCommand('检测到电冰箱', 'normal')">电冰箱 - 正常</button>
        <button class="ctrl-btn" style="color:#ff0" onclick="sendCommand('检测到台灯', 'normal')">台灯 - 工作中</button>
        <button class="ctrl-btn" style="color:#f00" onclick="sendCommand('检测到微波炉', 'abnormal')">微波炉 - 异常</button>
        <button class="ctrl-btn" style="color:#f00" onclick="sendCommand('检测到空调', 'abnormal')">空调 - 故障</button>
    </div>

    <script>
        // --- 核心配置修改 ---
        // 使用更稳定的 EMQX WSS 端口配置
        const mqttHost = "broker.emqx.io";
        const mqttPort = 8084; // SSL/WSS 端口
        const mqttPath = "/mqtt"; 
        
        // 为了防止冲突，请在 topic 后加个你自己的后缀，比如你的名字缩写
        const topic = "demo/app/blind_assist_v2_fixed"; 
        
        const clientID = "client_" + Math.random().toString(16).substr(2, 8);
        const client = new Paho.MQTT.Client(mqttHost, mqttPort, mqttPath, clientID);

        let isConnected = false;

        // --- 功能逻辑 ---
        function startDisplay() {
            document.getElementById('role-select').style.display = 'none';
            document.getElementById('display-view').style.display = 'flex';
            initAudio();
            connectMQTT(true);
        }

        function startController() {
            document.getElementById('role-select').style.display = 'none';
            document.getElementById('control-view').style.display = 'block';
            connectMQTT(false);
        }

        // --- MQTT 连接 (增强版) ---
        function connectMQTT(isReceiver) {
            document.getElementById('connection-status').style.display = 'block';
            document.getElementById('connection-status').innerText = "正在连接服务器...";
            document.getElementById('connection-status').style.background = "#ffa500";

            client.connect({
                useSSL: true, // 必须开启
                timeout: 5,
                keepAliveInterval: 60,
                onSuccess: () => {
                    console.log("MQTT Connected");
                    isConnected = true;
                    document.getElementById('connection-status').style.display = 'none'; // 连接成功隐藏提示
                    
                    if (isReceiver) {
                        client.subscribe(topic);
                        speakText("系统就绪");
                    }
                },
                onFailure: (e) => { 
                    console.log(e);
                    document.getElementById('connection-status').innerText = "连接失败，点击重试";
                    document.getElementById('connection-status').style.background = "red";
                    document.getElementById('connection-status').onclick = () => location.reload();
                    alert("服务器连接失败，请检查网络或刷新页面。\n错误码：" + e.errorCode + "\n信息：" + e.errorMessage);
                }
            });

            client.onConnectionLost = (responseObject) => {
                if (responseObject.errorCode !== 0) {
                    console.log("Connection Lost: " + responseObject.errorMessage);
                    document.getElementById('connection-status').style.display = 'block';
                    document.getElementById('connection-status').innerText = "连接断开";
                }
            };

            client.onMessageArrived = (message) => {
                const data = JSON.parse(message.payloadString);
                updateUI(data.text, data.type);
            };
        }

        function sendCommand(text, type) {
            if(!isConnected) {
                alert("未连接服务器，请刷新重试");
                return;
            }
            let fullText = text;
            if(type === 'normal' && text !== '无设备') fullText += "，工作正常";
            if(type === 'abnormal') fullText += "，工作异常，请注意";

            const payload = JSON.stringify({ text: fullText, type: type });
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            client.send(message);
        }

        function updateUI(text, type) {
            const resultDiv = document.getElementById('status-result');
            resultDiv.innerText = text;
            if (text.includes("异常")) resultDiv.style.color = "#ff3333";
            else if (text.includes("无设备")) resultDiv.style.color = "#888";
            else resultDiv.style.color = "#0f0";
            speakText(text);
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            window.speechSynthesis.speak(utterance);
        }

        // --- 修复后的音频可视化逻辑 ---
        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioCtx = new AudioContext();
            
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                const source = audioCtx.createMediaStreamSource(stream);
                const analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const canvas = document.getElementById('visualizer');
                const canvasCtx = canvas.getContext('2d');
                
                // 监听窗口大小改变，重置画布尺寸（解决模糊和拉伸问题）
                function resize() {
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                }
                window.addEventListener('resize', resize);
                resize(); // 初始化调用一次

                function draw() {
                    requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);

                    // 每次绘制前清空画布
                    canvasCtx.fillStyle = '#111'; 
                    canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                    const barWidth = (canvas.width / bufferLength) * 2.5;
                    let barHeight;
                    let x = 0;

                    for(let i = 0; i < bufferLength; i++) {
                        // 动态计算高度，防止超出
                        barHeight = (dataArray[i] / 255) * canvas.height; 
                        
                        const r = barHeight + (25 * (i/bufferLength));
                        const g = 250 * (i/bufferLength);
                        const b = 50;

                        canvasCtx.fillStyle = `rgb(${r},${g},${b})`;
                        canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                        x += barWidth + 1;
                    }
                }
                draw();
            }).catch(err => {
                console.error(err);
                alert("无法获取麦克风权限，无法展示声纹。");
            });
        }
    </script>
</body>
</html>
